<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¤äº’å¼DPOç®—æ³•æµè§ˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutral Harmony -->
    <!-- Application Structure Plan: The SPA is designed as a single-page, scrollable journey with a sticky navigation bar for easy access to different knowledge modules. The structure is thematic rather Pre-trainingthan linear: 1. A visual comparison of RLHF vs. DPO to immediately establish context and DPO's value proposition. 2. A breakdown of the core mathematical theory using interactive elements (hover-to-explain formulas) to make it digestible. 3. A simplified flowchart of the algorithm to bridge theory and code. 4. A clean presentation of the code itself. 5. A fully interactive simulator. 6. Two new LLM-powered features: a concept explainer and an application scenario generator, enhancing interactive learning and practical relevance. This structure allows users with different goals (e.g., theorist, practitioner) to navigate directly to their area of interest, while the simulator and LLM tools act as powerful, central tools for intuitive learning, which is far more effective than reading static text. -->
    <!-- Visualization & Content Choices: 
        - Report Info: RLHF vs DPO process. -> Goal: Compare. -> Viz: HTML/CSS diagram. -> Interaction: None. -> Justification: A clear, static visual is the fastest way to convey the structural difference and DPO's simplification.
        - Report Info: Mathematical formulas (Bradley-Terry, Reward, DPO Loss). -> Goal: Inform/Teach. -> Viz: Styled HTML text. -> Interaction: Hover tooltips on formula components. -> Justification: Deconstructs complex math into understandable parts without cluttering the UI, making it less intimidating.
        - Report Info: Algorithm steps. -> Goal: Organize. -> Viz: HTML/CSS flowchart. -> Interaction: None. -> Justification: Provides a high-level, easy-to-follow map of the process before the user delves into the detailed code.
        - Report Info: DPO Loss function dynamics. -> Goal: Engage/Teach. -> Viz: Interactive sliders and a Chart.js bar chart. -> Interaction: User manipulates sliders representing log probabilities and beta, causing the chart and calculated loss value to update in real-time. -> Justification: This is the core 'wow' factor. It transforms the abstract mathematical formula into a tangible, dynamic system, allowing users to build a strong, intuitive understanding of how different factors influence the DPO loss. Library: Chart.js on a Canvas element.
        - Report Info: General DPO concepts. -> Goal: Inform/Clarify. -> Viz: Text output. -> Interaction: User input text query, LLM generates explanation. Justification: Provides on-demand clarification for any DPO-related term or idea, leveraging LLM's knowledge. Library: Gemini API.
        - Report Info: DPO practical applications. -> Goal: Inspire/Contextualize. -> Viz: Text output (list). -> Interaction: Button click, LLM generates application scenarios. Justification: Connects theoretical knowledge to real-world utility, making the learning more relevant. Library: Gemini API.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #F9F7F3; color: #3D3D3D; }
        .nav-link { transition: color 0.3s, border-color 0.3s; }
        .nav-link.active { color: #3B82F6; border-bottom-color: #3B82F6; }
        .nav-link:hover { color: #3B82F6; }
        .card { background-color: #FFFFFF; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; transition: transform 0.3s, box-shadow 0.3s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1); }
        .flowchart-step { border: 2px solid #E5E7EB; padding: 1rem; border-radius: 0.5rem; text-align: center; }
        .flowchart-arrow { color: #9CA3AF; font-size: 2rem; margin: 0 1rem; }
        .code-block { background-color: #282C34; color: #ABB2BF; font-family: 'Courier New', Courier, monospace; padding: 1.5rem; border-radius: 0.5rem; overflow-x: auto; }
        .tooltip { position: relative; display: inline-block; border-bottom: 1px dotted #3D3D3D; cursor: help; }
        .tooltip .tooltiptext { visibility: hidden; width: 220px; background-color: #3D3D3D; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 0.875rem; font-weight: 400; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .chart-container { position: relative; height: 320px; width: 100%; max-width: 700px; margin: 2rem auto 0 auto; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #3B82F6; cursor: pointer; margin-top: -6px; }
        input[type=range]::-moz-range-thumb { height: 16px; width: 16px; border-radius: 50%; background: #3B82F6; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #D1D5DB; border-radius: 2px; }
        input[type=range]::-moz-range-track { width: 100%; height: 4px; cursor: pointer; background: #D1D5DB; border-radius: 2px; }
        .llm-button { background-color: #3B82F6; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.3s ease; display: inline-flex; items-center; justify-center; }
        .llm-button:hover { background-color: #2563EB; }
        .llm-output { background-color: #F0F4F8; border-radius: 0.5rem; padding: 1rem; min-height: 80px; margin-top: 1rem; border: 1px solid #E2E8F0; }
        .loading-spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #3B82F6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px; }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">

    <header class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">äº¤äº’å¼DPOç®—æ³•æµè§ˆå™¨</h1>
            <div class="hidden md:flex space-x-8">
                <a href="#intro" class="nav-link text-gray-600 font-medium border-b-2 border-transparent pb-1">ä»‹ç»</a>
                <a href="#theory" class="nav-link text-gray-600 font-medium border-b-2 border-transparent pb-1">æ ¸å¿ƒç†è®º</a>
                <a href="#flow" class="nav-link text-gray-600 font-medium border-b-2 border-transparent pb-1">ç®—æ³•æµç¨‹</a>
                <a href="#code" class="nav-link text-gray-600 font-medium border-b-2 border-transparent pb-1">ä»£ç å®ç°</a>
                <a href="#simulator" class="nav-link text-gray-600 font-medium border-b-2 border-transparent pb-1">äº¤äº’æ¨¡æ‹Ÿ</a>
                <a href="#llm-features" class="nav-link text-gray-600 font-medium border-b-2 border-transparent pb-1">AIåŠ©æ‰‹</a>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-12">

        <section id="intro" class="mb-24 text-center">
            <h2 class="text-4xl font-bold mb-4">æ·±å…¥ç†è§£ç›´æ¥åå¥½ä¼˜åŒ– (DPO)</h2>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto mb-12">
                DPOä¸ºå¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMsï¼‰å¯¹é½äººç±»åå¥½æä¾›äº†ä¸€ç§æ›´ç›´æ¥ã€æ›´ç¨³å®šçš„æ–°èŒƒå¼ã€‚æœ¬åº”ç”¨å°†é€šè¿‡å¯è§†åŒ–å¯¹æ¯”ã€ç†è®ºåˆ†è§£å’Œäº¤äº’å¼æ¨¡æ‹Ÿï¼Œå¸¦æ‚¨æ¢ç´¢DPOçš„å·¥ä½œåŸç†ï¼Œå°†å¤æ‚çš„æ¦‚å¿µå˜å¾—ç›´è§‚æ˜“æ‡‚ã€‚
            </p>
            
            <div class="grid md:grid-cols-2 gap-8 items-center">
                <div class="card text-left">
                    <h3 class="text-2xl font-semibold mb-3 text-center">ä¼ ç»Ÿ RLHF æµç¨‹</h3>
                    <p class="text-gray-600 mb-4 text-center">è¿™æ˜¯ä¸€ä¸ªå¤šé˜¶æ®µã€å¤æ‚çš„æµç¨‹ï¼Œä¾èµ–äºä¸€ä¸ªç‹¬ç«‹è®­ç»ƒçš„å¥–åŠ±æ¨¡å‹ã€‚</p>
                    <div class="space-y-2">
                        <div class="flowchart-step bg-blue-50">1. ç›‘ç£å¾®è°ƒ (SFT)</div>
                        <div class="text-center text-gray-400">â†“</div>
                        <div class="flowchart-step bg-yellow-50">2. è®­ç»ƒå¥–åŠ±æ¨¡å‹ (RM)</div>
                        <div class="text-center text-gray-400">â†“</div>
                        <div class="flowchart-step bg-green-50">3. PPOå¼ºåŒ–å­¦ä¹ </div>
                    </div>
                </div>
                <div class="card text-left">
                    <h3 class="text-2xl font-semibold mb-3 text-center">DPO æµç¨‹</h3>
                    <p class="text-gray-600 mb-4 text-center">DPOå°†å¥–åŠ±å­¦ä¹ å’Œç­–ç•¥ä¼˜åŒ–åˆå¹¶ä¸ºä¸€æ­¥ï¼Œç›´æ¥ä»åå¥½æ•°æ®ä¸­å­¦ä¹ ã€‚</p>
                    <div class="space-y-2">
                         <div class="flowchart-step bg-blue-50">1. ç›‘ç£å¾®è°ƒ (SFT)</div>
                        <div class="text-center text-gray-400">â†“</div>
                        <div class="flowchart-step bg-purple-50">2. ç›´æ¥åå¥½ä¼˜åŒ– (DPO)</div>
                    </div>
                </div>
            </div>
        </section>

        <section id="theory" class="mb-24">
            <h2 class="text-3xl font-bold text-center mb-2">æ ¸å¿ƒç†è®ºåˆ†è§£</h2>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto text-center mb-12">DPOçš„ä¼˜é›…ä¹‹å¤„åœ¨äºå…¶åšå®çš„æ•°å­¦åŸºç¡€ã€‚å®ƒå°†åå¥½å­¦ä¹ é—®é¢˜å·§å¦™åœ°è½¬åŒ–ä¸ºä¸€ä¸ªç®€å•çš„åˆ†ç±»ä»»åŠ¡ã€‚æˆ‘ä»¬æ¥ä¸€æ­¥æ­¥æ‹†è§£å®ƒçš„æ ¸å¿ƒå…¬å¼ã€‚</p>
            
            <div class="grid md:grid-cols-1 gap-8">
                <div class="card">
                    <h3 class="font-semibold text-xl mb-4">DPO ç›®æ ‡å‡½æ•°</h3>
                    <p class="text-gray-600 mb-6">DPOçš„ç›®æ ‡æ˜¯æœ€å¤§åŒ–æ‰€æœ‰åå¥½å¯¹çš„å¯¹æ•°ä¼¼ç„¶ã€‚è¿™æ„å‘³ç€ï¼Œæ¨¡å‹è¢«æ¿€åŠ±å»æé«˜â€œè·èƒœâ€å“åº”($y_w$)çš„æ¦‚ç‡ï¼ŒåŒæ—¶é™ä½â€œè½è´¥â€å“åº”($y_l$)çš„æ¦‚ç‡ã€‚</p>
                    <div class="code-block text-lg text-center p-8 bg-gray-100 text-gray-800">
                        <span class="font-serif italic">L</span><sub>DPO</sub> = ğ”¼<sub>(x, y<sub>w</sub>, y<sub>l</sub>)âˆ¼D</sub> [ log Ïƒ( 
                        <span class="tooltip">Î²<span class="tooltiptext">æ¸©åº¦ç³»æ•°Î²ï¼Œæ§åˆ¶å¯¹å‚è€ƒç­–ç•¥çš„åç¦»ç¨‹åº¦ã€‚Î²è¶Šé«˜ï¼Œç­–ç•¥è¶Šå€¾å‘äºåˆ©ç”¨å­¦åˆ°çš„åå¥½ï¼Œä½†ä¹Ÿå¯èƒ½åç¦»åŸå§‹æ¨¡å‹å¤ªè¿œã€‚</span></span>
                        ( log 
                        <span class="tooltip">Ï€<sub>Î¸</sub>(y<sub>w</sub>|x)<span class="tooltiptext">ç­–ç•¥æ¨¡å‹Ï€Î¸å¯¹â€œè·èƒœâ€å“åº”ywç”Ÿæˆçš„å¯¹æ•°æ¦‚ç‡ã€‚</span></span> 
                        - log 
                        <span class="tooltip">Ï€<sub>ref</sub>(y<sub>w</sub>|x)<span class="tooltiptext">å‚è€ƒæ¨¡å‹Ï€refå¯¹â€œè·èƒœâ€å“åº”ywç”Ÿæˆçš„å¯¹æ•°æ¦‚ç‡ã€‚</span></span>
                        ) - 
                        ( log 
                        <span class="tooltip">Ï€<sub>Î¸</sub>(y<sub>l</sub>|x)<span class="tooltiptext">ç­–ç•¥æ¨¡å‹Ï€Î¸å¯¹â€œè½è´¥â€å“åº”ylç”Ÿæˆçš„å¯¹æ•°æ¦‚ç‡ã€‚</span></span> 
                        - log 
                        <span class="tooltip">Ï€<sub>ref</sub>(y<sub>l</sub>|x)<span class="tooltiptext">å‚è€ƒæ¨¡å‹Ï€refå¯¹â€œè½è´¥â€å“åº”ylç”Ÿæˆçš„å¯¹æ•°æ¦‚ç‡ã€‚</span></span>
                        ) ) ]
                    </div>
                </div>
            </div>
        </section>

        <section id="flow" class="mb-24">
            <h2 class="text-3xl font-bold text-center mb-2">ç®—æ³•å·¥ä½œæµç¨‹</h2>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto text-center mb-12">DPOçš„è®­ç»ƒå¾ªç¯éå¸¸ç›´è§‚ã€‚ä»¥ä¸‹æ˜¯æ¯ä¸€æ­¥çš„æ ¸å¿ƒæ“ä½œï¼Œå®ƒå°†ç†è®ºå…¬å¼è½¬åŒ–ä¸ºå¯æ‰§è¡Œçš„è®¡ç®—è¿‡ç¨‹ã€‚</p>
            <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4">
                <div class="flowchart-step">1. åŠ è½½åå¥½æ•°æ®<br>(x, y<sub>w</sub>, y<sub>l</sub>)</div>
                <div class="flowchart-arrow hidden md:block">â†’</div>
                <div class="flowchart-step">2. è®¡ç®—å¯¹æ•°æ¦‚ç‡<br>Ï€<sub>Î¸</sub> å’Œ Ï€<sub>ref</sub></div>
                <div class="flowchart-arrow hidden md:block">â†’</div>
                <div class="flowchart-step">3. è®¡ç®—éšå¼å¥–åŠ±å·®</div>
                <div class="flowchart-arrow hidden md:block">â†’</div>
                <div class="flowchart-step">4. è®¡ç®—DPOæŸå¤±</div>
                <div class="flowchart-arrow hidden md:block">â†’</div>
                <div class="flowchart-step">5. æ›´æ–°ç­–ç•¥æ¨¡å‹ Ï€<sub>Î¸</sub></div>
            </div>
        </section>
        
        <section id="code" class="mb-24">
            <h2 class="text-3xl font-bold text-center mb-2">ä»£ç æ ¸å¿ƒå®ç°</h2>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto text-center mb-12">ç†è®ºçš„æœ€ç»ˆä½“ç°æ˜¯ä»£ç ã€‚è¿™é‡Œå±•ç¤ºäº†DPOæŸå¤±å‡½æ•°è®¡ç®—çš„æ ¸å¿ƒPythonä»£ç ï¼Œå®ƒç²¾ç¡®åœ°å®ç°äº†ä¸Šè¿°å…¬å¼å’Œæµç¨‹ã€‚</p>
            <div class="card">
                <h3 class="font-semibold text-xl mb-4">compute_dpo_loss å‡½æ•°</h3>
                <div class="code-block">
<pre><code>
# è®¡ç®—ç­–ç•¥æ¨¡å‹å’Œå‚è€ƒæ¨¡å‹å¯¹ chosen/rejected å“åº”çš„å¯¹æ•°æ¦‚ç‡
# chosen_log_probs_policy, chosen_log_probs_ref
# rejected_log_probs_policy, rejected_log_probs_ref

# DPOæŸå¤±çš„æ ¸å¿ƒè®¡ç®—é€»è¾‘
logits = self.beta * (
    (chosen_log_probs_policy - chosen_log_probs_ref) - 
    (rejected_log_probs_policy - rejected_log_probs_ref)
)

# DPOæŸå¤±å‡½æ•°æ˜¯ -log(sigmoid(logits)) çš„å‡å€¼
loss = -F.logsigmoid(logits).mean()

return loss
</code></pre>
                </div>
            </div>
        </section>

        <section id="simulator" class="mb-24">
            <h2 class="text-3xl font-bold text-center mb-2">äº¤äº’å¼æŸå¤±æ¨¡æ‹Ÿå™¨</h2>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto text-center mb-12">
                äº²æ‰‹æ“ä½œæ¥å»ºç«‹ç›´è§‰ï¼æ‹–åŠ¨ä¸‹æ–¹çš„æ»‘å—ï¼Œæ¨¡æ‹Ÿç­–ç•¥æ¨¡å‹ (Ï€<sub>Î¸</sub>) å’Œå‚è€ƒæ¨¡å‹ (Ï€<sub>ref</sub>) çš„å¯¹æ•°æ¦‚ç‡å˜åŒ–ã€‚è§‚å¯Ÿéšå¼å¥–åŠ±å’Œæœ€ç»ˆDPOæŸå¤±å¦‚ä½•å®æ—¶å“åº”æ‚¨çš„è°ƒæ•´ã€‚
            </p>

            <div class="card">
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <div class="mb-4">
                            <label for="pi_theta_w" class="font-medium">ç­–ç•¥æ¨¡å‹å¯¹ y<sub>w</sub> çš„å¯¹æ•°æ¦‚ç‡: <span id="pi_theta_w_val">-1.0</span></label>
                            <input type="range" id="pi_theta_w" min="-5" max="0" value="-1" step="0.1" class="w-full">
                        </div>
                        <div class="mb-4">
                            <label for="pi_ref_w" class="font-medium">å‚è€ƒæ¨¡å‹å¯¹ y<sub>w</sub> çš„å¯¹æ•°æ¦‚ç‡: <span id="pi_ref_w_val">-2.0</span></label>
                            <input type="range" id="pi_ref_w" min="-5" max="0" value="-2" step="0.1" class="w-full">
                        </div>
                        <div class="mb-4">
                            <label for="pi_theta_l" class="font-medium">ç­–ç•¥æ¨¡å‹å¯¹ y<sub>l</sub> çš„å¯¹æ•°æ¦‚ç‡: <span id="pi_theta_l_val">-3.0</span></label>
                            <input type="range" id="pi_theta_l" min="-5" max="0" value="-3" step="0.1" class="w-full">
                        </div>
                        <div class="mb-4">
                            <label for="pi_ref_l" class="font-medium">å‚è€ƒæ¨¡å‹å¯¹ y<sub>l</sub> çš„å¯¹æ•°æ¦‚ç‡: <span id="pi_ref_l_val">-2.5</span></label>
                            <input type="range" id="pi_ref_l" min="-5" max="0" value="-2.5" step="0.1" class="w-full">
                        </div>
                        <div class="mb-4">
                            <label for="beta" class="font-medium">æ¸©åº¦ç³»æ•° Î²: <span id="beta_val">0.1</span></label>
                            <input type="range" id="beta" min="0.01" max="1" value="0.1" step="0.01" class="w-full">
                        </div>
                    </div>
                    <div class="flex flex-col items-center justify-center space-y-4">
                        <div class="text-center">
                            <p class="text-gray-500">éšå¼å¥–åŠ± r(y<sub>w</sub>)</p>
                            <p class="text-2xl font-bold" id="reward_w">0.10</p>
                        </div>
                        <div class="text-center">
                            <p class="text-gray-500">éšå¼å¥–åŠ± r(y<sub>l</sub>)</p>
                            <p class="text-2xl font-bold" id="reward_l">-0.05</p>
                        </div>
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <p class="text-gray-600 font-semibold">æœ€ç»ˆDPOæŸå¤± (è¶Šå°è¶Šå¥½)</p>
                            <p class="text-4xl font-extrabold text-blue-600" id="dpo_loss">0.686</p>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="rewardChart"></canvas>
                </div>
            </div>
        </section>

        <section id="llm-features" class="mb-24">
            <h2 class="text-3xl font-bold text-center mb-2">âœ¨ AI åŠ©æ‰‹ âœ¨</h2>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto text-center mb-12">
                åˆ©ç”¨AIçš„åŠ›é‡ï¼Œæ›´æ·±å…¥åœ°æ¢ç´¢DPOç®—æ³•ï¼æ— è®ºæ˜¯æ¦‚å¿µç–‘é—®è¿˜æ˜¯åº”ç”¨åœºæ™¯ï¼ŒAIåŠ©æ‰‹éƒ½èƒ½ä¸ºæ‚¨æä¾›å³æ—¶æ´å¯Ÿã€‚
            </p>

            <div class="grid md:grid-cols-2 gap-8">
                <div class="card">
                    <h3 class="font-semibold text-xl mb-4">âœ¨ DPOæ¦‚å¿µè§£é‡Šå™¨ âœ¨</h3>
                    <p class="text-gray-600 mb-4">è¾“å…¥æ‚¨å¯¹DPOçš„ä»»ä½•ç–‘é—®ï¼ŒAIå°†ä¸ºæ‚¨æä¾›ç®€æ´çš„è§£é‡Šã€‚</p>
                    <textarea id="concept-query" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="ä¾‹å¦‚ï¼šDPOä¸­çš„Î²å‚æ•°æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ"></textarea>
                    <button id="explain-concept-btn" class="llm-button mt-4">
                        <span id="explain-concept-spinner" class="loading-spinner hidden"></span>
                        âœ¨ è§£é‡Šæ¦‚å¿µ âœ¨
                    </button>
                    <div id="concept-output" class="llm-output mt-4 text-gray-700"></div>
                </div>

                <div class="card">
                    <h3 class="font-semibold text-xl mb-4">âœ¨ DPOåº”ç”¨åœºæ™¯å»ºè®® âœ¨</h3>
                    <p class="text-gray-600 mb-4">ç‚¹å‡»æŒ‰é’®ï¼Œè·å–DPOåœ¨å¤§å‹è¯­è¨€æ¨¡å‹å¯¹é½ä¸­çš„å®é™…åº”ç”¨åœºæ™¯å»ºè®®ã€‚</p>
                    <button id="suggest-scenarios-btn" class="llm-button mt-4">
                        <span id="suggest-scenarios-spinner" class="loading-spinner hidden"></span>
                        âœ¨ è·å–åœºæ™¯å»ºè®® âœ¨
                    </button>
                    <div id="scenarios-output" class="llm-output mt-4 text-gray-700"></div>
                </div>
            </div>
        </section>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sliders = {
                pi_theta_w: document.getElementById('pi_theta_w'),
                pi_ref_w: document.getElementById('pi_ref_w'),
                pi_theta_l: document.getElementById('pi_theta_l'),
                pi_ref_l: document.getElementById('pi_ref_l'),
                beta: document.getElementById('beta'),
            };

            const values = {
                pi_theta_w_val: document.getElementById('pi_theta_w_val'),
                pi_ref_w_val: document.getElementById('pi_ref_w_val'),
                pi_theta_l_val: document.getElementById('pi_theta_l_val'),
                pi_ref_l_val: document.getElementById('pi_ref_l_val'),
                beta_val: document.getElementById('beta_val'),
            };

            const outputs = {
                reward_w: document.getElementById('reward_w'),
                reward_l: document.getElementById('reward_l'),
                dpo_loss: document.getElementById('dpo_loss'),
            };

            const ctx = document.getElementById('rewardChart').getContext('2d');
            const rewardChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['è·èƒœå“åº” (yw)', 'è½è´¥å“åº” (yl)'],
                    datasets: [{
                        label: 'éšå¼å¥–åŠ±',
                        data: [0, 0],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.6)',
                            'rgba(239, 68, 68, 0.6)',
                        ],
                        borderColor: [
                            'rgba(59, 130, 246, 1)',
                            'rgba(239, 68, 68, 1)',
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'å¥–åŠ±å€¼'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `å¥–åŠ±: ${context.parsed.y.toFixed(3)}`;
                                }
                            }
                        }
                    }
                }
            });

            function calculateDPO() {
                const pi_theta_w = parseFloat(sliders.pi_theta_w.value);
                const pi_ref_w = parseFloat(sliders.pi_ref_w.value);
                const pi_theta_l = parseFloat(sliders.pi_theta_l.value);
                const pi_ref_l = parseFloat(sliders.pi_ref_l.value);
                const beta = parseFloat(sliders.beta.value);

                values.pi_theta_w_val.textContent = pi_theta_w.toFixed(2);
                values.pi_ref_w_val.textContent = pi_ref_w.toFixed(2);
                values.pi_theta_l_val.textContent = pi_theta_l.toFixed(2);
                values.pi_ref_l_val.textContent = pi_ref_l.toFixed(2);
                values.beta_val.textContent = beta.toFixed(2);

                const reward_w = beta * (pi_theta_w - pi_ref_w);
                const reward_l = beta * (pi_theta_l - pi_ref_l);
                
                const logits = reward_w - reward_l;
                const loss = -Math.log(1 / (1 + Math.exp(-logits)));

                outputs.reward_w.textContent = reward_w.toFixed(3);
                outputs.reward_l.textContent = reward_l.toFixed(3);
                outputs.dpo_loss.textContent = loss.toFixed(3);
                
                rewardChart.data.datasets[0].data = [reward_w, reward_l];
                rewardChart.update();
            }
            
            Object.values(sliders).forEach(slider => {
                slider.addEventListener('input', calculateDPO);
            });

            calculateDPO();

            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('section');
            
            window.addEventListener('scroll', () => {
                let current = '';
                sections.forEach(section => {
                    const sectionTop = section.offsetTop;
                    if (pageYOffset >= sectionTop - 100) {
                        current = section.getAttribute('id');
                    }
                });

                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href').includes(current)) {
                        link.classList.add('active');
                    }
                });
            });

            navLinks.forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    document.querySelector(this.getAttribute('href')).scrollIntoView({
                        behavior: 'smooth'
                    });
                });
            });

            // LLM Integration
            const conceptQueryInput = document.getElementById('concept-query');
            const explainConceptBtn = document.getElementById('explain-concept-btn');
            const conceptOutput = document.getElementById('concept-output');
            const explainConceptSpinner = document.getElementById('explain-concept-spinner');

            const suggestScenariosBtn = document.getElementById('suggest-scenarios-btn');
            const scenariosOutput = document.getElementById('scenarios-output');
            const suggestScenariosSpinner = document.getElementById('suggest-scenarios-spinner');

            async function callGeminiAPI(prompt, outputElement, spinnerElement) {
                outputElement.innerHTML = ''; // Clear previous output
                spinnerElement.classList.remove('hidden'); // Show spinner

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas will provide this at runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        outputElement.innerHTML = text.replace(/\n/g, '<br>'); // Display newlines as <br>
                    } else {
                        outputElement.textContent = 'æœªèƒ½è·å–åˆ°æœ‰æ•ˆå›å¤ï¼Œè¯·é‡è¯•ã€‚';
                        console.error('Gemini API response structure unexpected:', result);
                    }
                } catch (error) {
                    outputElement.textContent = 'è°ƒç”¨APIæ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åå†è¯•ã€‚';
                    console.error('Error calling Gemini API:', error);
                } finally {
                    spinnerElement.classList.add('hidden'); // Hide spinner
                }
            }

            explainConceptBtn.addEventListener('click', () => {
                const query = conceptQueryInput.value.trim();
                if (query) {
                    const prompt = `è¯·ç”¨ä¸­æ–‡ç®€æ´åœ°è§£é‡ŠDPOç®—æ³•ä¸­çš„"${query}"ã€‚`;
                    callGeminiAPI(prompt, conceptOutput, explainConceptSpinner);
                } else {
                    conceptOutput.textContent = 'è¯·è¾“å…¥æ‚¨æƒ³äº†è§£çš„æ¦‚å¿µã€‚';
                }
            });

            suggestScenariosBtn.addEventListener('click', () => {
                const prompt = "è¯·åˆ—ä¸¾3-5ä¸ªDPOç®—æ³•åœ¨å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰å¯¹é½ä¸­çš„å…·ä½“åº”ç”¨åœºæ™¯ï¼Œç”¨ä¸­æ–‡ä»¥åˆ—è¡¨å½¢å¼å‘ˆç°ã€‚";
                callGeminiAPI(prompt, scenariosOutput, suggestScenariosSpinner);
            });
        });
    </script>

</body>
</html>
